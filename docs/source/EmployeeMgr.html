<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />    
  <title>The source code</title>
    <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
</head>
<body  onload="prettyPrint();">
    <pre class="prettyprint lang-js">Ext.ns("CompanyMgr");

<div id="cls-CompanyMgr.EmployeeMgr"></div>/**
 * @class CompanyMgr.EmployeeMgr
 * @extends Ext.Panel
 * An Ext.Window implementation that contains  the {@link Ext.layout.FitLayout fit} layout to
 *  present {@link TKE.form.EmployeeMgrForm} implementation.
 * <br />
 * @constructor
 * @param {Object} config The config object
 **/
CompanyMgr.EmployeeManager = Ext.extend(Ext.Panel, {
    border        : false,
    layout        : 'hbox',
    layoutConfig  : { align : 'stretch' },
    msgs          : {
        immediateChanges : 'Warning! Changes are <span style="color: red;">immediate</span>.',        
        errorsInForm     : 'There are errors in the form. Please correct and try again.',
        empSavedSuccess  : 'Saved {0}, {1} successfully.',
        fetchingDataFor  : 'Fetching data for {0}, {1}',
        couldNotLoadData : 'Could not load data for {0}, {1}!',
        saving           : 'Saving {0}, {1}',
        errorSavingData  : 'There was an error saving the form.',
        deleteEmpConfirm : 'Are you sure you want to delete employee {0}, {1}?',
        deleteEmpSuccess : 'Emplyoee {0}, {1} was deleted successfully.'
    },
    initComponent : function() {
        this.employeeForm = this.buildEmployeeForm();

        Ext.apply(this, {
            items : [
                this.buildDepartmentListView(),
                this.buildEmployeeListView(),
                this.employeeForm
            ]
        });

        CompanyMgr.DepartmentManager.superclass.initComponent.call(this);
    },

    buildDepartmentListView : function() {
        this.departmentListView = new TKE.list.DepartmentList({
            url       : 'departments/getList',
            listeners : {
                scope : this,
                click : this.onDepartmentListClick
            }
        });

        return {
            width     : 190,
            border    : false,
            style     : 'border-right: 1px solid #99BBE8;',
            layout    : 'fit',
            title     : 'Departments',
            items     : this.departmentListView
        };
    },

    buildEmployeeListView : function() {
        this.employeeListView = new TKE.list.EmployeeList({
            autoLoad  : false,
            url       : 'employees/listForDepartment', 
            listeners : {
                scope : this,
                click : this.onEmployeeListClick
            }
        });

        return {
            width     : 190,
            border    : false,
            style     : 'border-right: 1px solid #99BBE8;',
            layout    : 'fit',
            title     : 'Employees',
            items     : this.employeeListView
        };

    },

    buildEmployeeForm : function() {
        return new TKE.form.EmployeeMgrForm({
            flex      : 1,
            border    : false,
            listeners : {
                scope     : this,
                newemp    : this.onNewEmployee,
                delemp    : this.onDeleteEmployee,
                saveemp   : this.onSaveEmployee,
                resetform : this.onResetEmployeeForm
            }
        });

    },

    onNewEmployee : function(selectedDepartment) {
        this.employeeListView.clearSelections();
        this.setDeptIdOnForm();
    },

    onDeleteEmployee : function(formPanel, vals) {
        var msg = String.format(this.msgs.deleteEmpConfirm, vals.lastName, vals.firstName);
        Ext.MessageBox.confirm(
            this.msgs.immediateChanges,
            msg,
            this.onConfirmDeleteEmployee,
            this
        );
    },

    onConfirmDeleteEmployee : function(btn) {
        if (btn === 'yes') {
            var vals = this.employeeForm.getValues();
            Ext.Ajax.request({
                url          : 'employees/deleteEmployee',
                scope        : this,
                callback     : this.workspace.onAfterAjaxReq,
                succCallback : this.onAfterDeleteEmployee,
                params       : {
                    id : vals.id
                }
            });
        }
    },

    onAfterDeleteEmployee : function(jsonData) {
        if (jsonData.success === true) {
            var selectedEmployee = this.employeeListView.getSelectedRecords()[0];

            var msg = String.format(
                this.msgs.deleteEmpSuccess,
                selectedEmployee.get('lastName'),
                selectedEmployee.get('firstName')
            );

            selectedEmployee.store.remove(selectedEmployee);
            this.employeeForm.clearForm();
        }
    },

    setDeptIdOnForm : function(selectedDepartment) {
        selectedDepartment = selectedDepartment || this.departmentListView.getSelectedRecords()[0];

        if (selectedDepartment) {
            this.employeeForm.setValues({
                departmentId : selectedDepartment.get('id'),
                dateHired    : new Date()
            });
        }
    },
    
    onDepartmentListClick : function() {
        var selectedDepartment = this.departmentListView.getSelectedRecords()[0];
        this.employeeListView.store.load({
            params : {
                id : selectedDepartment.get('id')
            }
        });
        this.employeeForm.clearForm();
        this.setDeptIdOnForm(selectedDepartment);
    },

    onEmployeeListClick : function() {
        var record = this.employeeListView.getSelectedRecords()[0];
        if (record) {
            var msg = String.format(
                this.msgs.fetchingDataFor,
                record.get('lastName'),
                record.get('firstName')
            );

            Ext.getBody().mask(msg, 'x-mask-loading');

            this.employeeForm.load({
                url     : 'employees/getEmployee',
                scope   : this,
                success : this.clearMask,
                failure : this.handleLoadError,
                params  : {
                    id : record.get('id')
                }
            });
        }
    },

    onResetEmployeeForm : function() {
        this.onEmployeeListClick();
    },

    clearMask : function(data) {
        Ext.getBody().unmask();
    },

    handleLoadError : function() {
        var record = this.employeeListView.getSelectedRecords()[0];
        var msg = String.format(
            this.msgs.couldNotLoadData,
            record.get('lastName'),
            record.get('firstName')
        );

        Ext.MessageBox.show({
            title   : 'Error',
            msg     : msg,
            buttons : Ext.MessageBox.OK,
            icon    : Ext.MessageBox.WARNING
        });
        this.clearMask();
    },

    onSaveEmployee : function(employeeForm, vals) {
        var record = this.employeeListView.getSelectedRecords()[0];

        if (employeeForm.getForm().isValid()) {

            var msg = String.format(
                this.msgs.saving,
                vals.lastName,
                vals.firstName
            );

            Ext.getBody().mask(msg, 'x-mask-loading');
            
            employeeForm.getForm().submit({
                url     : 'employees/setEmployee',
                scope   : this,
                success : this.onEmpFormSaveSuccess,
                failure : this.onEmpFormSaveFailure
            });

        }
        else {
            Ext.MessageBox.alert('Error', this.msgs.errorsInForm);
        }
    },
    
    onEmpFormSaveSuccess : function(form, action) {
        var record = this.employeeListView.getSelectedRecords()[0];
        var vals = form.getValues();
        
        var msg = String.format(
            this.msgs.empSavedSuccess,
            vals.lastName,
            vals.firstName
        );

        if (record) {
            record.set('lastName', vals.lastName);
            record.set('firstname', vals.firstName);
            record.commit();
            Ext.MessageBox.alert('Success', msg);

            this.clearMask();
        }
        else {
            this.employeeListView.createAndSelectRecord(vals);
            this.employeeForm.setValues(action.result.data);
        }
        this.clearMask();

    },
    
    onEmpFormSaveFailure : function() {
        this.clearMask();
        Ext.MessageBox.alert('Error', this.msgs.errorSavingForm);
    },

    cleanSlate : function () {
        this.departmentListView.refreshView();
        this.employeeListView.clearView();
        this.employeeForm.clearForm();
    }
});

Ext.reg('CompanyMgr_manage_employees', CompanyMgr.EmployeeManager);</pre>    
</body>
</html>