<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />    
  <title>The source code</title>
    <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
</head>
<body  onload="prettyPrint();">
    <pre class="prettyprint lang-js">Ext.ns("CompanyMgr");
<div id="cls-CompanyMgr.DepartmentMgr"></div>/**
 * @class CompanyMgr.DepartmentMgr
 * @extends Ext.Panel
 * NEEDS A DESCRIPTION
 * <br />
 * @constructor
 * @param {Object} config The config object
 * @xtype companymgr_manage_departments
 **/
CompanyMgr.DepartmentManager = Ext.extend(Ext.Panel, {
    layout        : 'border',
    border        : false,
    msgs          : {
        empSavedSuccessfully    : 'Employee {0}, {1} was saved successfully',
        deletingEmployees       : 'Deleting {0} employees.',
        deletedEmployees        : 'Deleted {0} employees',
        assocEmployeeConfirm    : 'Are you sure you want to associate {0} employees to {1}?',
        immediateChanges        : 'Warning! Changes are <span style="color: red;">immediate</span>.',
        associatingEmployees    : 'Associating {0} employees to {1}',
        assocEmployeeSuccess    : 'Successfully associated {0} employee(s) with {1}.',
        confirmUnsetDepartment : 'Are you sure you want to deactivate the {0} department and all of its employees?',
        succUnsetDepartment    : '{0} and all associated employee(s) has been deleted successfully.'
    },
    initComponent : function() {
        this.CompanyMgrFormCtrPnl = this.buildCenterPanel();

        Ext.apply(this, {
            items : [
                this.buildDptListWestPnl(),
                this.CompanyMgrFormCtrPnl
            ]    
        });
        CompanyMgr.DepartmentManager.superclass.initComponent.call(this);

    },
    buildDptListWestPnl : function() {
        this.departmentListView = new TKE.list.DepartmentList({
            flex      : 1,
            url       : 'departments/getList',
            listeners : {
                scope : this,
                click : this.onDepartmentListClick
            }
        });

        return {
            split     : true,
            resizable : true,
            region    : 'west',
            width     : 155,
            border    : false,
            style     : 'border-right: 1px solid #99BBE8;',            
            layout    : 'fit',
            items     : this.departmentListView,
            tbar      :  [
                {
                    text    : 'New Department',
                    iconCls : 'icon-group_add',
                    scope   : this,
                    handler : this.onNewDepartment
                }
            ]
        };

    },
    buildCenterPanel : function() {
        return new TKE.form.DepartmentMgrForm({
            region    : 'center',
            border    : false,
            style     : 'border-left: 1px solid #99BBE8;',
            listeners : {
                scope           : this,
                save            : this.onCenterPanelSave,
                newemployee     : this.onCenterPanelNewEmployee,
                editemployee    : this.onCenterPanelEditEmployee,
                deleteemployees : this.onCenterPanelDeleteEmployees,
                assocemployees  : this.onCenterPanelAssocEmployees,
                unsetdepartment : this.onCenterPanelUnsetDepartment
            }
        });
    },

    onDepartmentListClick : function() {
        this.loadDepartment();
    },
    onNewDepartment : function() {
        this.clearFormPanel();
        this.CompanyMgrFormCtrPnl.getForm().setValues({
            dateActive : new Date()
        });
    },
    clearFormPanel : function() {
        this.departmentListView.clearSelections();
        this.selectedDeptRecord  = null;
        delete  this.selectedDeptRecord ;
        this.CompanyMgrFormCtrPnl.clearForm();
    },

    onCenterPanelSave : function(panel, vals) {
       if (this.CompanyMgrFormCtrPnl.getForm().isValid()) {
            Ext.getBody().mask('Saving ' + vals.name, 'x-mask-loading');

            Ext.Ajax.request({
                url          : 'departments/setDepartment',
                scope        : this,
                callback     : this.workspace.onAfterAjaxReq,
                succCallback : this.onAfterCenterPanelSave,
                params       : {
                    department : Ext.encode(vals)
                }
            });
       }
    },
    
    onCenterPanelEditEmployee : function(centerPanel, grid, record) {
        new CompanyMgr.EmployeeEditorWindow({
            record    : record,
            listeners : {
                employeeSaved : {
                    single : true,
                    scope  : this,
                    fn     : this.onEmployeeWindowSaveSuccess
                }
            }
        }).show();
    },
    onCenterPanelNewEmployee : function(centerPanel, grid) {
        var departmentId = centerPanel.getValues().id;
        new CompanyMgr.EmployeeEditorWindow({
            departmentId : departmentId,
            listeners    : {
                employeeSaved : {
                    single : true,
                    scope  : this,
                    fn     : this.onEmployeeWindowSaveSuccess
                }
            }
        }).show();
    },
    onEmployeeWindowSaveSuccess : function(formVals, action, record) {
        
        var msg = String.format(
            this.msgs.empSavedSuccessfully,
            formVals.firstName,
            formVals.lastName
        );


        if (record) {
            if (formVals.departmentId !== record.get('departmentId')) {
                record.store.remove(record);
            }
            else {
                for (var val in formVals) {
                    record.set(val, formVals[val]);
                }
                record.commit();
            }
        }
        else {
            this.CompanyMgrFormCtrPnl.genNewEmployeeRecord(action.result.data);
        }
        Ext.MessageBox.alert('Success', msg);
    },
    loadDepartment : function() {

        this.selectedDeptRecord = this.departmentListView.getSelectedRecords()[0];

        Ext.getBody().mask(
            'Fetching data for ' + this.selectedDeptRecord.get('name'),
            'x-mask-loading'
        );
   
        Ext.Ajax.request({
            url          : 'departments/getDepartment',
            scope        : this,
            callback     : this.workspace.onAfterAjaxReq,
            succCallback : this.loadCenterPanel,
            params       : {
                id : this.selectedDeptRecord.get('id')
            }
        });
    },
    loadCenterPanel : function(jsonData) {
        this.CompanyMgrFormCtrPnl.loadData(jsonData)
    },
    onAfterCenterPanelSave : function(jsonData) {
        if (this.selectedDeptRecord) {
            this.selectedDeptRecord.set('name', jsonData.name);
            this.selectedDeptRecord.commit();
        }
        else {
            this.selectedDeptRecord = this.departmentListView.createAndSelectRecord(jsonData);
        }
        
        this.CompanyMgrFormCtrPnl.loadData(jsonData);
    },

    onCenterPanelDeleteEmployees : function(records, grid, editorPanel) {
        var deptRec =  this.selectedDeptRecord;
        var employees = this.spoolEmpIdsFromRecords(records);
        
        var msg = String.format(this.msgs.deletingEmployees, records.length);
        Ext.getBody().mask(msg, 'x-mask-loading');

        Ext.Ajax.request({
            url          : 'employees/deleteEmployees',
            scope        : this,
            callback     : this.workspace.onAfterAjaxReq,
            succCallback : this.onAfterDeleteEmployees,
            records      : records,
            params       : {
                employeeIds : Ext.encode(employees)
            }
        });
    },
    onAfterDeleteEmployees : function(jsonData, options) {
        if (jsonData.success === true) {
            Ext.each(options.records, function(record) {
                record.store.remove(record);
            });
            var msg = String.format(this.msgs.deletedEmployees, options.records.length);
            Ext.MessageBox.alert('Success', msg);
        }
    },
    onCenterPanelAssocEmployees : function(records, windowGrid, assocWindow) {
        var deptRec =  this.selectedDeptRecord ;
        var msg = String.format(
            this.msgs.assocEmployeeConfirm,
            records.length, 
            deptRec.get('name')
        );
        
        Ext.MessageBox.confirm(
            this.msgs.immediateChanges,
            msg,
            function(btn) {
                if (btn === 'yes') {
                    this.onConfirmAssocEmployees(records,  windowGrid, assocWindow, deptRec);
                }
            },
            this
        );
    },
    spoolEmpIdsFromRecords : function(records) {
        var employees = [];

        Ext.each(records, function(record) {
            employees.push({
                id : record.get('id')
            });
        });

        return employees;
    },

    onConfirmAssocEmployees : function(records, windowGrid, assocWindow, deptRec) {

        var employees = this.spoolEmpIdsFromRecords(records);
        var msg = String.format(
            this.msgs.associatingEmployees,
            records.length,
            deptRec.get('name')
        );
        
        Ext.getBody().mask(msg, 'x-mask-loading');

        Ext.Ajax.request({
            url          : 'employees/assocToDepartment',
            scope        : this,
            callback     : this.workspace.onAfterAjaxReq,
            succCallback : this.onAfterAssocEmployees,
            records      : records,
            deptName     : deptRec.get('name'),
            windowGrid   : windowGrid,
            params       : {
                departmentId : deptRec.get('id'),
                employeeIds  : Ext.encode(employees)
            }
        });

    },

    onAfterAssocEmployees : function(jsonData, options) {
       if (jsonData.success === true) {
           var msg = String.format(
               this.msgs.assocEmployeeSuccess,
               options.records.length,
               options.deptName
           );
           Ext.MessageBox.alert('Success', msg);
           options.windowGrid.remove(options.records);
           this.CompanyMgrFormCtrPnl.addRecordsToEmployeesGrid(options.records);
       }
    },

    onCenterPanelUnsetDepartment : function() {
        var msg = String.format(this.msgs.confirmUnsetDepartment, this.selectedDeptRecord.get('name'));
        Ext.MessageBox.confirm(
            this.msgs.immediateChanges,
            msg,
            this.onConfirmUnsetDepartment,
            this
        );
    },

    onConfirmUnsetDepartment : function(btn) {
        if (btn === 'yes') {

            Ext.Ajax.request({
                url          : 'departments/unsetDepartment',
                scope        : this,
                callback     : this.workspace.onAfterAjaxReq,
                succCallback : this.onAfterUnsetDepartment,
                params       : {
                    id : this.selectedDeptRecord.get('id')
                }
            });
        }
    },

    onAfterUnsetDepartment : function(jsonData) {

        if (jsonData.success === true) {
            var msg = String.format(
                this.msgs.succUnsetDepartment,
                this.selectedDeptRecord.get('name')
            );
            Ext.MessageBox.alert('Success', msg);
            this.selectedDeptRecord.store.remove(this.selectedDeptRecord);
            this.clearFormPanel();
        }
    },

    cleanSlate : function() {
        this.clearFormPanel();
        this.departmentListView.refreshView();
    }

});

Ext.reg('CompanyMgr_manage_departments', CompanyMgr.DepartmentManager);</pre>    
</body>
</html>